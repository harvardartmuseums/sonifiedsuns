<!DOCTYPE html>
<html>
<head>

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Sonified Suns Control App</title>

<style>
	html, body {
		width: 100%;
		height: 100%;
		margin: 0px; 
		padding: 10%; 
		overflow: hidden; 
		background: #000000;
		font-size: 20px;
		color: #FFFFFF;
		font-family: 'Inconsolata', Monaco, monospace;
	}
	div {
		background-color: #000000;
		position: absolute;
		top: 0px;
		left: 0px;
		width: 100vw;
		height: 100vh;
		display: flex;
		align-items: center;
		justify-content: center;
	}
	div span {
		display: block;
		text-align: center;
		transition: color 1s;
	}
	#message {
		display: none;
		z-index: 10;
	}
	.click {
		color: #000000;
	}
</style>

<link href="https://fonts.googleapis.com/css?family=Inconsolata" rel="stylesheet"> 

</head>

<body>

<div id="message"></div>
<div id="controls">
<span><span onclick="explain()" id="explain">Tap here or say "explain" to hear an explanation of the tones</span><br /><br /><br /><br /><br /><br />
<span onclick="readComments()" id="comments">Tap here or say "comments" to hear a selection of comments from your fellow visitors</span></span>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
var socket = io('/control-namespace');

var recognition = new webkitSpeechRecognition();
var commenting = false;
var commentEnder = undefined;
var commentFinalEnder = undefined;
var speechCounter = 10;
var comments = ["No comments recorded yet", "", "", "", ""];
var comment = "";

socket.on('commenting', function() {
	commentEnder = setTimeout(commentOff, 10000);
	commentFinalEnder = setTimeout(commentTooLong, 90000);
	commenting = true;
	comment = "";
});

socket.on('too many sockets', function() {
	document.body.innerHTML = '';
	alert("Another instance of this page is attempting to connect; please wait a few minutes and try again.");
});

socket.on('timed out', function() {
	document.body.innerHTML = '';
	alert("This attempt to connect timed out; please try again. Be sure to open an instance of http://sonifiedsuns.herokuapps.com/screens.html and an instance of http://sonifiedsuns.herokuapps.com/projectors.html within a minute of reloading this page.");
});

socket.on('message', function(text) {
	document.getElementById("message").innerHTML = "<span>" + text + "</span>";
	document.getElementById("message").style.display = "flex";
});

function closeMessage() {
	document.getElementById("message").innerHTML = "";
	document.getElementById("message").style.display = "none";
}

socket.on('close message', function() {
	closeMessage();
});

function unclickExplain() {
	document.getElementById("explain").className = "";
}

function explain() {
	socket.emit('explain request');
	document.getElementById("explain").className = "click";
	setTimeout(unclickExplain, 1000);
}

function unclickComments() {
	document.getElementById("comments").className = "";
}

function readComments() {
	socket.emit('comment request');
	document.getElementById("comments").className = "click";
	setTimeout(unclickComments, 1000);
}

setup();

function setup() {
	// set up speech recognition
	//recognition.continuous = true;
	recognition.lang = "en-US";
	recognition.onsoundstart = function(event) {
		if (commenting && (commentEnder != undefined)) {
                clearTimeout(commentEnder);
                commentEnder = undefined;
		}
	};
	recognition.onresult = function(event) {
		var currentSpeech = "";

		for (var i = event.resultIndex; i < event.results.length; i++) {
			currentSpeech += " " + event.results[i][0].transcript;
		};

		if (commenting) {
			comment += currentSpeech;
                if (commentEnder != undefined) {
                	clearTimeout(commentEnder);
                }
			commentEnder = setTimeout(commentOff, 10000);
		} else {
			if ((currentSpeech.indexOf("explain") != -1) ||
				(currentSpeech.indexOf("explanation") != -1)) {
				explain();
			};

			if (currentSpeech.indexOf("comment") != -1) {
				readComments();
			};
		}

		i = null;
		event = null;
		currentSpeech = null;
	};
	recognition.onend = function(event) {
		recognition.start();
	};
	recognition.start();
}

function commentOff() {
	clearTimeout(commentFinalEnder);
	commentFinalEnder = undefined;
	commentEnder = undefined;
	commenting = false;
	if (comment) {
		if ((comments[0] == "") || (comments[0] == "No comments recorded yet")) {
			comments.shift();
		}
		comments.push(comment);
		email(comment);
	} 
	socket.emit('comment end', comments);
	closeMessage();
}

function commentTooLong() {
	clearTimeout(commentEnder);
	commentFinalEnder = undefined;
	commentEnder = undefined;
	commenting = false;
	if (comment) {
		if ((comments[0] == "") || (comments[0] == "No comments recorded yet")) {
			comments.shift();
		}
		comments.push(comment);
		email(comment);
	} 
	socket.emit('comment end', comments);
	closeMessage();
}

function email(text) {
	socket.emit('email', text);
}

</script>
</body>
</html>